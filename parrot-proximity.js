var images = [
    E.toArrayBuffer(atob("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////7///////////////////39/////////////////8UAAD////////////////gqvkD//////////////9wHjOcA//////////////4CPpfph//////////////BFDO/+B/////////////warHoFmB////////////8N3zAADOD////////////hVAKRGBAP///////////4d4LwO8AAP///////////DvgcCNQYC///////////4JkJkJMgBj//////////+H/4ux/5HGH//////////wPUj9Bp0Zgf/////////8F73+WBSh+x//////////gsr+743AGmh/////////8Pp9f/hwY/GD////////vh3tVo2KpgH8f////////+H93994PYLHi/////////w/e/9+Afw+hB/////////Fy+7puCmHTSP////////4enFt9gOgMR4/////////AP/j2scCC+/j////////4Hf+867kA/esf////////gO3P/d7gCOrh////////4sCvl/56gvNdH////////hgfoc/6GGZCIf///////4GV+734Nof1dH////////D+MuOd/9/jhgf///////gK3BPvHJ7/iXx///////8B/6A+/8p+Z+eH//////8A/16B2dd896P4f/////+gXeLqAW1f7c0Uj/////9gvyf3LBAfdr8M+H/////gH7Y/y+6aO3Wuu4v////4JgBPtb4O+/vte5g////+Bq/M3q/xRn/if35j////4Pt04fH34P/U987eH////Fh2ztq3vGz8PlnvQP///03PuR1+vf/2sdZ364f///ifNe/fHi/viehP7/g///8AIMJEEQAIAACAA8AD///gAAAAAAAAAAAAAAAAH/8=")),
    E.toArrayBuffer(atob("////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////OP/////////////////+AAA/////////////////ADsgP///////////////g1/54D//////////////4Pf/f3D/////////////9Hfu7usD/////////////g0fnCDWH////////////8O6uIADUH////////////B1L0FADgf///////////4uwGgfsAA////////////CaAUGiggB///////////4OMCYw8SCHf//////////HYafAhsMIH//////////wX+G8NaYe4f//////////jltPoKjBWwf/////////4Hvv5hnKO/g//////////Bb1N6B6c98o/////////+MvJl8ZYBe6D/////////xfzsx5ygbzuH////////+G2/j2B1A9f0X////////4NrFf7HwBvfof////////wr1x+4Twv/2h/////////NaP/64EHL33H////////8a+1/YAkfscsf////////xf3+i/wNdbvQ/////////B+1u9uge7zeH////////+cz7XfcDFNH4f////////4Yr92t6P3xth/////////ge/ff9f/g+qP/////////gc21aqe6vzc/////////+AT3+d56mbpgf////////wQdm1+U/v/ugP////////mAGv/d8/qNokB///////4doBW43ReRxQ2Af//////B5yAVb//37vNqAf/////4f/WAD3olH/OVvwH/////Dm2sAzXy6zPfP+4H////w73b2Ovd/W9vqT/IH////H/qkUU+Zs+P39y/cH///4aW9Xf/XffeKdB++mH///g1d5a1ftvmS2s+/W9P//+K3d/Vnb/j586/NWfwP//wXP+Bt/ftre2Y///dAP//EARAAAAAwAQBAAAAEAf/4AAAAAAAAAAAAAAAAAAc=")),
    E.toArrayBuffer(atob("///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9gAB///+////////////8AAIAH//////////////+AL6bwP//////////////wc+yf4P/////////////8FeHz7QH/////////////A6ff3/8f////////////4SO7/hz4////////////+HXrzAAfw////////////wdp7wAAMD///////////+PeD+A3CAH///////////w+4EYJKAAP//////////+DcQKgFaCA///////////xf+B8ARQAh//////////+L/994Vwi/h//////////4f9fWDTEHsD//////////Erv7uELA72H/////////4b55/wBFHy+H/////////jte+YgmI3OoP////////8PB/24H8D770f////////yVf9n4Y0P/fR////////+Gv///4IAnA+D////////8O/3/dRqCCf4H////////wv/3z9Awc/uwf////////Dn/ov+ADR3Xj////////8Oufn3IIb1fyO////////4F7r8bsD/bbw/////////w8/tv+cLP/9G/////////SLv//S3zev8H////////8B+/rv//+69sC////////4A+/Svu3iOM8I////////AH97+Ti+f7/+QD//////4aL9Hp6/9+vydQC//////w0H7773erP0T+7B//////BQEe//6zx0n8HrAv////8DyAXX3vfv/+99Nwf////xmtAAP//r10L/3T0P////Dv70AL9Z2vX2s/PwH///+H/+vILE+e9XjfbzYH///4d/6fS/N5v+e+w/9wD///hZAiEBAAAgAAAgCIgP///CAAAAAAAAAAAAAAAAH/8=")),
    E.toArrayBuffer(atob("////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////f///////////////////////////////////////////f////////////////////////////////////////////////////////////9////////////////////4cj/////////////////+ABAf//////////////+8A6tAD///////////////AuFtwB//////////////gbf5++D/////////////gX9/3/9D////////////8DP3939/X////////////w//9eE/MP///////////8b776AAD4P///////////B7hPwDAEgf//////////4Fsg+LB4YB/////////3/B/8BuC2gAHv/////////8X/wOwA2IAf//////////hu73/lsUEwf/////////8H6//4NIA/g//////////Df/+/xhQH7h/////////8Pf//2EAwT+b/////////x/18/8ORA/6H////////+D///foBiL38P////////wTf///glQn75/////////Dva///FEDXfh///////+8ef87f8AI/7+H////////x/s//90LD2XY/////////H7////hwvv+D////////g//3P/9Aj934P////////n1Xvu3/AO+vx////////8D//6/fsEd+/P////////wP7/f+z8X//w////////wAOP/99/87v/H3/7/////Dwv//+uHv7/8f///////x8gO2967s/v/j///////8f9kB/z7////mH///////BX5cABr/9/+/4f//////8f//vAA/e//97h///////h//9r9S7fqu9kH//////8EBBgAAAAAKbQoP//////wAAAAAAAAAAAAAf////8=")),
    E.toArrayBuffer(atob("/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////v///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9gAO////////////////4AhBAv//////////////8APndAH//////////////A+Yz9wH/////////////w6du+7OH////////////8Fc7vr/uH///////////+B637AI/sP///////////w9fGaAA2Qf//////////8B8lCg1V0w///////////A1cBsCpCAH//////////4J+wIAlYICH/////////+C+9AsAQIBVf/////////gV7eXoIyhGR/////////+H6v+/ilUB7D/////////gpe/p9Bnob8P////////4A7vniQaYx/Kf////////i+j9PVgBgLsg////////8Bn2/O+DrAdfD///////+gHg5f3cHsB/4P///////8A9/611cKUNn8f///////iFL/ltmgDD+8R///////+Ab9/muFgwSe9H///////gwJFm5O+Az83sf//////wDD32mVz4AL7dD//////4B/D/1r/X4A7zsf/////8BfoC7W7f+sHmfg//////jCT+B/mXq+ZUmqP/////gK//wD95X5Zm79w/////4C2+ZeB/33+6sd8H////+HP/5f4Ad9nnQn+Y////vh/qu4+2wJx71vtrj////wT5P+39N0AAp/+68P///4Tnv5T+qpthR795Xw////wrB+279v9v8b378fB///4N71Xlfdz3dv9+LrcP///ghRCAZQAgBQYkAAhAf//+AAAAAAAAAAAAAAAAA//8=")),
].map(function (buff) {
      return {width: 124, height: 64, bpp: 1, transparent: 0, buffer: buff};
});

var maxFrameTime = 2050;
var minFrameTime = 50;
var neighbourTimeReduction = 200;

var frameTimeout; // clear to pause refresh rate

var searchTime = 60000;
var neighboursNearby = 0;
var searchInterval;

function displayGif (gifArray) {
    if (frameTimeout) clearTimeout(frameTimeout);
    var currentIndex = -1;

    function drawImage () {
        currentIndex = ++currentIndex % gifArray.length;
        g.clear();
        g.drawImage(gifArray[index], 0, 0);
        g.flip();
        frameTimeout = setTimeout(() => drawImage, Math.max(minFrameTime, maxFrameTime - (neighbourTimeReduction * neighboursNearby)));
    }

    drawImage();
}

function setupBroadcast () {
    NRF.setAdvertising({
        0xBAAF: [42]
    }, {
        interval: 500
    });
}

function setupFindNeighboursOnService () {
    setInterval(function () {
        neighboursNearby = 0;
        
        var scanTimeout = setTimeout(function () {
            NRF.setScan();
        }, 1000);

        NRF.setScan(function (device) {
            if (device.servicedata.baaf) {
                neighboursNearby++;
            }
            if (neighboursNearby >= 10) {
                NRF.setScan();
            }
        })
    }, searchTime);
};

setupBroadcast();
setupFindNeighboursOnService();
displayGif(images);
